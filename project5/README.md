# Project 5: SM2 软件实现与优化实验报告

本项目基于 Python 实现 SM2 椭圆曲线公钥密码算法的签名/验签，并围绕常见“签名算法的误用”开展可复现实验与 PoC。项目内容包括：
- SM3 哈希算法。
- SM2 曲线与标量运算、密钥生成、签名、验签。
- 实验与 PoC：
  1) 重复使用随机数 k 导致私钥泄露与伪造签名；
  2) 省略 ZA（身份绑定）导致身份混淆/验证行为异常；
- 额外讨论：实现优化思路与边界检查。

## 目录结构

project5/
├── README.md
├── experiments/
│   ├── demo_k_mode_compare.py
│   ├── demo_omit_ZA.py
│   └── demo_reuse_k.py
├── run_all.py
├── sm2/
│   ├── curve.py
│   ├── sm2.py
│   ├── sm3.py
│   └── util.py
└── tests/
  └── test_sm2_basic.py

## 数学背景与推导

设 SM2 曲线参数为 (p, a, b, G, n, h)，其中 h=1。用户私钥 d∈[1, n−1]，公钥 P=dG。

签名时：
1) 计算 ZA = SM3(ENTL||ID||a||b||Gx||Gy||Px||Py)，e = SM3(ZA || M)。
2) 取随机 k∈[1, n−1]，计算 (x1, y1) = kG，r = (e + x1) mod n；若 r=0 或 r+k=n，重选 k。
3) s = ((1 + d)^{-1} · (k − r·d)) mod n；若 s=0，重选 k。
签名为 (r, s)。

验签时：
1) 检查 r, s ∈ [1, n−1]。
2) 计算 ZA 与 e = SM3(ZA || M)。
3) 计算 t = (r + s) mod n，若 t=0，拒绝。
4) 计算 (x1, y1) = sG + tP，R = (e + x1) mod n。
5) 若 R == r，接受。

### 误用一：重复使用随机数 k
由 s = ((k − r·d) / (1 + d)) mod n，可改写为
k ≡ s + d·(s + r) (mod n)。
对两条使用同一 k 的不同消息签名 (r1, s1, e1)、(r2, s2, e2)，可消去 k 得到：
0 ≡ (s1 − s2) + d·((s1 + r1) − (s2 + r2)) (mod n)
因此
d ≡ (s2 − s1) · ((s1 + r1) − (s2 + r2))^{-1} (mod n)
据此可恢复私钥 d，进而对任意消息伪造签名。

### 误用二：省略 ZA 导致的身份绑定缺失
SM2 规定 e = SM3(ZA || M)，其中 ZA 与用户身份 ID 强绑定。若错误实现成 e = SM3(M)，则签名与身份解绑，易出现未知密钥共享（UKS）与跨身份验证异常：
- 同一签名在不同 ID 的验证环境下可能被错误接受；
- 无法达成预期的实体绑定与抗替换性质。
实验部分给出对比验证。

## 实现与优化思路

- 椭圆曲线点运算采用简单的仿射坐标实现，Python 大整数已足够支持课程规模实验。
- 优化方向（讨论）：
  - Jacobian 坐标减少求逆次数；
  - 标量乘法使用窗口/NAF；
  - 批量验证时的多标量乘法融合。
- 本实现保留清晰性为主，实验中给出运行时间基线。
 - 补充实现：确定性 k 生成（基于 SM3(d||e||ctr)）以避免重复 k 风险，并便于复现。

## 实验设计

- 实验 A：基本正确性与性能
  - 随机消息若干，签名并验证，记录平均耗时。
- 实验 B：重复 k 的 PoC
  - 对两条消息使用相同 k 签名，利用上式恢复 d；随后用恢复出的 d 对消息“我是中本聪”签名，验证通过。
- 实验 C：省略 ZA 的验证对比
  - 在正确实现下，同一签名在更换 ID 后验证失败；在错误实现（省略 ZA）下，验证错误地通过。
 - 实验 D：确定性 k 与随机 k 对比
   - 对同一批消息分别用随机 k 与确定性 k 签名，对比功能正确性与时间开销。

运行方式见文末。

## 结果与分析

- 基础正确性与性能：
  - 用例通过；签名 50 条约 1.80 s，验证约 3.47 s。
  - 性能瓶颈主要在标量乘法（重复点加）与求逆运算。
- 重复 k PoC：
  - 两条消息在固定 k 下签名，利用公式 d ≡ (s2−s1)·((s1+r1)−(s2+r2))^{-1} (mod n) 成功恢复私钥，恢复值与真实 d 完全一致。
  - 使用恢复出的 d 对“我是中本聪”消息签名，验签通过，证明可伪造签名。
  - 说明：这里的“伪造中本聪的数字签名”仅指在练习环境中，攻击者通过误用（重复 k）恢复出对应密钥后，能够对任意语义的消息进行签名的能力展示。
- 省略 ZA 对比：
  - 正确实现（含 ZA）下，更换 ID 验证失败；错误实现（省略 ZA）下，同一签名对不同 ID 仍然通过，体现身份绑定缺失的风险。
 - 确定性 k：
  - 正常通过验证；本次对比（N=20）随机 k 签名约 678.81 ms，确定性 k 签名约 689.31 ms，性能接近。

结论：
- 重复 k 会直接泄露私钥，必须使用强随机或 RFC6979 类确定性 k（基于 e、d、消息）并确保唯一性。
- ZA 对于身份绑定是必要的，省略会破坏安全目标。

## 使用方法

- 运行全部实验：

```bash
python3 project5/run_all.py
```

- 仅运行某个实验：

```bash
python3 project5/experiments/demo_reuse_k.py
python3 project5/experiments/demo_omit_ZA.py
python3 project5/experiments/demo_k_mode_compare.py
```

环境依赖：仅 Python 3.8+，无第三方包。

## 参考资料

- 国家密码管理局公告：《SM2 椭圆曲线公钥密码算法》与《推荐曲线参数》
  - https://www.oscca.gov.cn/sca/xxgk/2010-12/17/content_1002386.shtml
- IETF Internet-Draft: SM2 Digital Signature Algorithm (工作草案，包含 ZA 与签名/验签流程的英文描述)
  - https://datatracker.ietf.org/doc/html/draft-shen-sm2-ecdsa-02
- docs/20250713-wen-sm2-public_00.png
- docs/20250713-wen-sm2-public.pdf
